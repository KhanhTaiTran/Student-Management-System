<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Take Quiz</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .question-card {
        transition: all 0.3s;
        border-left: 5px solid #0d6efd;
      }
      .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .form-check-input:checked + .form-check-label {
        font-weight: bold;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="card shadow-sm mb-4">
        <div
          class="card-body d-flex justify-content-between align-items-center"
        >
          <div>
            <h2 id="quizTitle" class="text-primary fw-bold mb-1">
              Loading Quiz...
            </h2>
            <p id="quizDesc" class="text-muted mb-0">Please wait...</p>
          </div>
          <div>
            <a href="/student/quizzes" class="btn btn-outline-secondary"
              ><i class="fa-solid fa-xmark"></i> Exit</a
            >
          </div>
        </div>
      </div>

      <form id="quizForm">
        <div id="questionsContainer"></div>

        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-success btn-lg px-5 shadow">
            <i class="fa-solid fa-paper-plane"></i> Submit Exam
          </button>
        </div>
      </form>
    </div>

    <input type="hidden" id="quizId" th:value="${quizId}" />
    <div th:replace="fragments/footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const token = localStorage.getItem("accessToken");
      const quizId = document.getElementById("quizId").value;
      let totalQuestions = 0;

      document.addEventListener("DOMContentLoaded", function () {
        loadQuizContent();
      });

      // load quiz content
      function loadQuizContent() {
        fetch(`/api/student/quizzes/${quizId}/take`, {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => {
            if (!res.ok) throw new Error("Quiz not found");
            return res.json();
          })
          .then((data) => {
            document.getElementById("quizTitle").innerText = data.title;
            document.getElementById("quizDesc").innerText = data.description;

            const container = document.getElementById("questionsContainer");
            container.innerHTML = "";
            totalQuestions = data.questions.length;

            data.questions.forEach((q, index) => {
              const num = index + 1;

              const radioName = `q_${q.id}`;

              const html = `
                <div class="card shadow-sm mb-4 question-card" data-qid="${q.id}">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <span class="badge bg-primary me-2">Q${num}</span> 
                            ${q.questionText}
                        </h5>
                        
                        <div class="list-group">
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="${radioName}" value="A">
                                <span>A. ${q.optionA}</span>
                            </label>
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="${radioName}" value="B">
                                <span>B. ${q.optionB}</span>
                            </label>
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="${radioName}" value="C">
                                <span>C. ${q.optionC}</span>
                            </label>
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="${radioName}" value="D">
                                <span>D. ${q.optionD}</span>
                            </label>
                        </div>
                    </div>
                </div>`;
              container.insertAdjacentHTML("beforeend", html);
            });
          })
          .catch((err) => {
            alert("Error loading quiz: " + err.message);
            window.location.href = "/student/quizzes";
          });
      }

      // handle submit
      document
        .getElementById("quizForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!confirm("Are you sure you want to submit?")) return;

          let answers = [];
          const cards = document.querySelectorAll(".question-card");

          cards.forEach((card) => {
            const questionId = card.getAttribute("data-qid");
            //find the checked radio button -> the answer of student
            const checkedRadio = card.querySelector(
              `input[type="radio"]:checked`
            );

            if (checkedRadio) {
              answers.push({
                questionId: parseInt(questionId),
                selectedOption: checkedRadio.value,
              });
            }
          });

          const payload = {
            quizId: parseInt(quizId),
            answers: answers,
          };

          try {
            const res = await fetch("/api/student/quizzes/submit", {
              method: "POST",
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (res.ok) {
              const result = await res.json();

              alert(
                `ðŸŽ‰ SUBMISSION SUCCESSFUL!\n\nYour Score: ${result.score} / 10.0`
              );
              window.location.href = "/student/quizzes";
            } else {
              alert("Submission failed. Please try again.");
            }
          } catch (err) {
            console.error(err);
            alert("Network error.");
          }
        });
    </script>
  </body>
</html>
