<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Quizzes</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <nav
          class="col-md-3 col-lg-2 sidebar p-3 bg-dark text-white collapse d-md-block"
          style="min-height: 100vh"
        >
          <a
            href="/"
            class="d-flex align-items-center mb-3 text-white text-decoration-none"
          >
            <i class="fa-solid fa-graduation-cap fs-4 me-2"></i>
            <span class="fs-5 fw-bold">SMS Teacher</span>
          </a>
          <hr />

          <ul class="nav flex-column">
            <li class="nav-item">
              <a href="/teacher/dashboard" class="nav-link text-white">
                <i class="fa-solid fa-chart-line me-2"></i> Dashboard
              </a>
            </li>

            <li class="nav-item">
              <a href="/teacher/classes" class="nav-link text-white">
                <i class="fa-solid fa-chalkboard-user me-2"></i> Classes
              </a>
            </li>

            <li class="nav-item">
              <a
                href="/teacher/quizzes"
                class="nav-link active bg-primary text-white"
              >
                <i class="fa-solid fa-file-circle-question me-2"></i> Quizzes
              </a>
            </li>

            <li class="nav-item mt-5">
              <a href="#" onclick="logout()" class="nav-link text-danger">
                <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
              </a>
            </li>
          </ul>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mt-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fa-solid fa-list-check"></i> My Quizzes</h2>
            <a href="/teacher/quiz/create" class="btn btn-primary">
              <i class="fa-solid fa-plus"></i> Create New Quiz
            </a>
          </div>

          <div class="card shadow-sm">
            <div class="card-body p-0">
              <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Quiz Title</th>
                    <th>Class</th>
                    <th>Description</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody id="quizTableBody"></tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <div class="modal fade" id="editQuizModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fa-solid fa-pen-to-square"></i> Edit Quiz Content
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body bg-light">
            <form id="editQuizForm">
              <input type="hidden" id="editQuizId" />

              <div class="card mb-3">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8 mb-3">
                      <label class="form-label fw-bold">Title</label>
                      <input
                        type="text"
                        id="editTitle"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Description</label>
                      <input type="text" id="editDesc" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>

              <h5 class="text-primary mt-4">
                <i class="fa-solid fa-circle-question"></i> Questions
              </h5>
              <div id="modalQuestionsContainer"></div>

              <button
                type="button"
                class="btn btn-outline-primary w-100 border-dashed"
                onclick="addModalQuestion()"
              >
                <i class="fa-solid fa-plus"></i> Add Question
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="saveQuizChanges()"
            >
              <i class="fa-solid fa-save"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const token = localStorage.getItem("accessToken");
      let editModal;
      let modalUniqueId = 0;

      document.addEventListener("DOMContentLoaded", function () {
        editModal = new bootstrap.Modal(
          document.getElementById("editQuizModal")
        );
        loadQuizzes();
      });

      // load list of quize
      function loadQuizzes() {
        fetch("/api/teacher/quizzes", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.getElementById("quizTableBody");
            tbody.innerHTML = "";
            if (data.length === 0) {
              tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No quizzes found.</td></tr>`;
              return;
            }

            data.forEach((q, index) => {
              const className =
                q.classroom && q.classroom.className
                  ? q.classroom.className
                  : "Unknown";
              tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold text-primary">${q.title}</td>
                        <td><span class="badge bg-info text-dark">${className}</span></td>
                        <td>${q.description || "-"}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${
                              q.id
                            })">
                                <i class="fa-solid fa-eye"></i> View / Edit
                            </button>
                        </td>
                    </tr>
                `;
            });
          });
      }

      // open modal and get the detail of quiz
      async function openEditModal(id) {
        try {
          // Reset container
          document.getElementById("modalQuestionsContainer").innerHTML = "";
          document.getElementById("editQuizId").value = id;
          modalUniqueId = 0;

          const res = await fetch(`/api/teacher/quizzes/${id}`, {
            headers: { Authorization: "Bearer " + token },
          });
          const quiz = await res.json();

          document.getElementById("editTitle").value = quiz.title;
          document.getElementById("editDesc").value = quiz.description;

          if (quiz.questions && quiz.questions.length > 0) {
            quiz.questions.forEach((q) => {
              addModalQuestion(q);
            });
          } else {
            addModalQuestion();
          }

          editModal.show();
        } catch (err) {
          console.error(err);
          alert("Error loading quiz details");
        }
      }

      function addModalQuestion(data = null) {
        modalUniqueId++;

        const qText = data ? data.questionText : "";
        const optA = data ? data.optionA : "";
        const optB = data ? data.optionB : "";
        const optC = data ? data.optionC : "";
        const optD = data ? data.optionD : "";
        const correct = data ? data.correctAnswer : "A";

        const checkA = correct === "A" ? "checked" : "";
        const checkB = correct === "B" ? "checked" : "";
        const checkC = correct === "C" ? "checked" : "";
        const checkD = correct === "D" ? "checked" : "";

        const html = `
        <div class="card shadow-sm mb-3 modal-q-card" id="m-card-${modalUniqueId}">
            <div class="card-header d-flex justify-content-between align-items-center bg-white">
                <strong class="text-primary m-label">Question ...</strong>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeModalQuestion(${modalUniqueId})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <input type="text" class="form-control m-q-text fw-bold" placeholder="Question Text" value="${qText}" required>
                </div>
                <div class="row g-2">
                    <div class="col-md-6"><div class="input-group input-group-sm">
                        <div class="input-group-text"><input class="form-check-input mt-0 m-correct" type="radio" name="m-correct-${modalUniqueId}" value="A" ${checkA}></div>
                        <input type="text" class="form-control m-opt-a" placeholder="Option A" value="${optA}">
                    </div></div>
                    <div class="col-md-6"><div class="input-group input-group-sm">
                        <div class="input-group-text"><input class="form-check-input mt-0 m-correct" type="radio" name="m-correct-${modalUniqueId}" value="B" ${checkB}></div>
                        <input type="text" class="form-control m-opt-b" placeholder="Option B" value="${optB}">
                    </div></div>
                    <div class="col-md-6"><div class="input-group input-group-sm">
                        <div class="input-group-text"><input class="form-check-input mt-0 m-correct" type="radio" name="m-correct-${modalUniqueId}" value="C" ${checkC}></div>
                        <input type="text" class="form-control m-opt-c" placeholder="Option C" value="${optC}">
                    </div></div>
                    <div class="col-md-6"><div class="input-group input-group-sm">
                        <div class="input-group-text"><input class="form-check-input mt-0 m-correct" type="radio" name="m-correct-${modalUniqueId}" value="D" ${checkD}></div>
                        <input type="text" class="form-control m-opt-d" placeholder="Option D" value="${optD}">
                    </div></div>
                </div>
            </div>
        </div>`;

        document
          .getElementById("modalQuestionsContainer")
          .insertAdjacentHTML("beforeend", html);
        renumberModalQuestions();
      }

      function removeModalQuestion(id) {
        document.getElementById(`m-card-${id}`).remove();
        renumberModalQuestions();
      }

      function renumberModalQuestions() {
        document.querySelectorAll(".modal-q-card").forEach((card, index) => {
          card.querySelector(".m-label").innerText = `Question ${index + 1}`;
        });
      }

      async function saveQuizChanges() {
        if (!confirm("Save changes to this Quiz?")) return;

        const quizId = document.getElementById("editQuizId").value;
        const cards = document.querySelectorAll(".modal-q-card");
        let questions = [];

        cards.forEach((card) => {
          let correct = "A";
          card.querySelectorAll(".m-correct").forEach((r) => {
            if (r.checked) correct = r.value;
          });

          questions.push({
            questionText: card.querySelector(".m-q-text").value,
            optionA: card.querySelector(".m-opt-a").value,
            optionB: card.querySelector(".m-opt-b").value,
            optionC: card.querySelector(".m-opt-c").value,
            optionD: card.querySelector(".m-opt-d").value,
            correctAnswer: correct,
          });
        });

        const payload = {
          title: document.getElementById("editTitle").value,
          description: document.getElementById("editDesc").value,
          questions: questions,
        };

        try {
          const res = await fetch(`/api/teacher/quizzes/${quizId}`, {
            method: "PUT",
            headers: {
              Authorization: "Bearer " + token,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            alert("✅ Updated Successfully!");
            editModal.hide();
            loadQuizzes();
          } else {
            alert("❌ Update Failed!");
          }
        } catch (err) {
          console.error(err);
          alert("System Error");
        }
      }
      function logout() {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("role");
        window.location.href = "/";
      }
    </script>
  </body>
</html>
